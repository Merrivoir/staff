<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Существующие метатеги и стили -->
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
    <link rel="manifest" href="favicon/site.webmanifest" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <title>Richmom Club Events</title>
    
    <!-- Стиль для скрытия контента до проверки -->
    <style>
        .pre-auth {
            display: none;
        }
    </style>
</head>

<body>
  <!-- Контейнер для контента (скрыт до проверки) -->
  <div id="content" class="pre-auth">
    <div class="head">
      <h1 id="calendar"></h1>
      <div id="sync-container" class="hidden">
        <div id="sync"></div>
        <span id="sync-label">Актуализация...</span>
      </div> 
    </div>
    <div id="list-container" class="list-container hidden"></div>
  </div>

  <!-- Модальное окно -->
  <div id="loadingModal" class="modal">
    <div class="modal-content">
      <div class="spinner"></div>
      <div class="hexagon" style="display:none"></div>
      <p>Загрузка данных, пожалуйста, подождите...</p>
    </div>
  </div>
    
  <script>
    const myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjE5MTIzNjUxNDgiLCJyb2xlIjoiYWRtaW4iLCJ1c2VybmFtZSI6Ik1lcnJpdm9pciIsImlhdCI6MTczODQ1OTc5MiwiZXhwIjoxNzM4NTQ2MTkyfQ.4lMcL9RDUwYpR4In5g0K_zQSJZuq0Isi46E5G_0C-e8");

    const graphql = JSON.stringify({
      query: "",
      variables: {}
    })
    
    const requestOptions = {
      method: "POST",
      headers: myHeaders,
      body: graphql,
      redirect: "follow"
    };

    fetch("richmom.vercel.app/verify", requestOptions)
      .then((response) => response.text())
      .then((result) => console.log(result))
      .catch((error) => console.error(error));
  </script>

  <!-- Скрипт проверки авторизации -->
  <script>
    (async function initAuth() {
      let token = localStorage.getItem('jwt');
      const authServerURL = 'https://richmom.vercel.app/verify';
      const loginURL = 'https://richmom.vercel.app';

      if (!token) {
        token = getTokenFromUrl();
      }

      try {
        if (!token) throw new Error('No token found');

        // Проверка токена
        const response = await fetch(authServerURL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Invalid token');
                
        // Показываем контент
        document.getElementById('content').classList.remove('pre-auth');
                
        // Динамически загружаем основные скрипты
        await loadScript('nextGame.js');
        await loadScript('calendar.js');
        await loadScript('misc.js');

      } catch (error) {
        console.error('Auth error:', error);
        //window.location.href = `${loginURL}?source=${encodeURIComponent(window.location.href)}`;
      } finally {
        document.getElementById('content').classList.remove('pre-auth');
        await loadScript('nextGame.js');
        await loadScript('calendar.js');
        await loadScript('misc.js');
      }

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.body.appendChild(script);
        });
      }

      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token');
      }
    })();
  </script>
</body>
</html>